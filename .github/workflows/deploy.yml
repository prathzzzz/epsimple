name: Parallel Build & Flexible Service Deploy

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  # ====================================================
  # JOB 1: BUILD FRONTEND
  # ====================================================
  build-frontend:
    runs-on: self-hosted
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set Bun Path
        shell: powershell
        run: |
          $BunPath = "C:\Users\Admin\.bun\bin"
          echo "$BunPath" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
          
      - name: Verify Local Bun Installation
        run: bun --version

      - name: Install & Build React
        working-directory: ./client-app
        run: |
          bun install
          bun run build

      - name: Upload Frontend Artifact
        uses: actions/upload-artifact@v4
        with:
          name: frontend-dist
          path: client-app/dist/
          retention-days: 1

  # ====================================================
  # JOB 2: BUILD BACKEND
  # ====================================================
  build-backend:
    runs-on: self-hosted
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Verify Local Java Installation
        run: java -version
          
      - name: Build Java Modules
        working-directory: ./server-api
        run: |
          mvn clean install -f common-module/pom.xml
          mvn clean install -f auth-module/pom.xml
          mvn clean install -f entity-module/pom.xml
          mvn clean install -f crypto-module/pom.xml
          mvn clean install -f epsoneapi/pom.xml

      - name: Upload Backend Artifact
        uses: actions/upload-artifact@v4
        with:
          name: backend-jar
          path: server-api/epsoneapi/target/epsoneapi-*.jar
          retention-days: 1

---

  # ====================================================
  # JOB 3: DEPLOY FRONTEND (Runs if Frontend Build succeeds)
  # ====================================================
  deploy-frontend:
    # ðŸš¨ FIX: Explicitly checks if the needed job succeeded
    needs: [build-frontend]
    if: needs.build-frontend.result == 'success'
    runs-on: self-hosted
    
    steps:
      - name: Download Frontend Artifact
        uses: actions/download-artifact@v4
        with:
          name: frontend-dist
          path: ./ready-to-deploy/dist

      - name: Copy Frontend Files via WinRM
        shell: powershell
        env:
          SERVER_IP: "192.168.83.23"
          USER: ${{ secrets.SERVER_USERNAME }}
          PASS: ${{ secrets.SERVER_PASSWORD }}
        run: |
          $pass = $env:PASS | ConvertTo-SecureString -AsPlainText -Force
          $cred = New-Object System.Management.Automation.PSCredential($env:USER, $pass)
          $session = New-PSSession -ComputerName $env:SERVER_IP -Credential $cred -Port 5985

          $root = "E:\epsone"
          $clientDir = "$root\client-api\dist"
          
          Write-Host "Starting Frontend Deployment..."
          
          # Clean remote dist folder
          Invoke-Command -Session $session -ScriptBlock {
              param($path)
              if (Test-Path $path) { Remove-Item "$path\*" -Recurse -Force }
          } -ArgumentList $clientDir
          
          # Upload new React build to E:\epsone\client-api\dist
          Copy-Item -Path ".\ready-to-deploy\dist\*" -Destination $clientDir -ToSession $session -Recurse -Force
          
          Write-Host "Frontend Deployment Complete."
          Remove-PSSession $session

---
  # ====================================================
  # JOB 4: DEPLOY BACKEND (Runs only if Backend Build succeeds)
  # ====================================================
  deploy-backend:
    # Requires both builds to succeed
    needs: [build-frontend, build-backend]
    if: always() && needs.build-frontend.result == 'success' && needs.build-backend.result == 'success'
    runs-on: self-hosted
    
    steps:
      - name: Download Backend Artifact
        uses: actions/download-artifact@v4
        with:
          name: backend-jar
          path: ./ready-to-deploy/jar

      - name: Stop Service, Backup, Deploy, Start Service
        shell: powershell
        env:
          SERVER_IP: "192.168.83.23"
          USER: ${{ secrets.SERVER_USERNAME }}
          PASS: ${{ secrets.SERVER_PASSWORD }}
        run: |
          $pass = $env:PASS | ConvertTo-SecureString -AsPlainText -Force
          $cred = New-Object System.Management.Automation.PSCredential($env:USER, $pass)
          $session = New-PSSession -ComputerName $env:SERVER_IP -Credential $cred -Port 5985

          $root = "E:\epsone"
          $apiDir = "$root\server-api"
          $backupRoot = "$apiDir\backup-jars"
          $serviceName = "epsone-backend"

          # A. STOP SERVICE
          Invoke-Command -Session $session -ScriptBlock {
              param($svc)
              $service = Get-Service -Name $svc -ErrorAction SilentlyContinue
              if ($service -and $service.Status -eq 'Running') {
                  Write-Host "Stopping Service: $svc..."
                  Stop-Service -Name $svc -Force
                  Start-Sleep -Seconds 5
              }
          } -ArgumentList $serviceName

          # B. BACKUP (Timestamped Folder)
          Invoke-Command -Session $session -ScriptBlock {
              param($path, $backupRoot)
              $dateStr = Get-Date -Format "yyyy-MM-dd_HH-mm"
              $currentBackupFolder = "$backupRoot\$dateStr"
              $oldJar = Get-ChildItem -Path $path -Filter "epsoneapi-*.jar" | Select-Object -First 1
              
              if ($oldJar) {
                  New-Item -Path $currentBackupFolder -ItemType Directory -Force | Out-Null
                  Move-Item -Path $oldJar.FullName -Destination $currentBackupFolder -Force
                  Write-Host "Backed up JAR to: $currentBackupFolder"
              }
          } -ArgumentList $apiDir, $backupRoot

          # C. UPLOAD NEW JAR
          Write-Host "Uploading new JAR..."
          $localJar = Get-ChildItem -Path ".\ready-to-deploy\jar\epsoneapi-*.jar" | Select-Object -First 1
          Copy-Item -Path $localJar.FullName -Destination $apiDir -ToSession $session -Force

          # D. START SERVICE
          Invoke-Command -Session $session -ScriptBlock {
              param($svc)
              Write-Host "Starting Service: $svc..."
              Start-Service -Name $svc
          } -ArgumentList $serviceName

          Remove-PSSession $session
          Write-Host "Backend Deployment Complete."